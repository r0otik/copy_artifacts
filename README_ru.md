
---

## Назначение скрипта

`copyArtifacts.py` предназначен для:
- копирования большого объёма файлов с удалённых хостов (SFTP/SSH),
- отбора файлов по дате и шаблону имени,
- опциональной распаковки `.gz` файлов

---

## Формат конфигурационного файла

Скрипт использует конфигурационный файл формата **INI**.

Пример имени файла:
```text
config_copyArtifacts.ini
```

Конфигурация состоит из:
- обязательной секции `[general]`;
- одной или нескольких секций источников копирования (произвольные имена секций).

---

## Секция [general]

Секция `[general]` содержит **глобальные параметры выполнения**, которые применяются ко всем источникам копирования по принципу *override*, аналогично systemd-units.

Это означает:
- параметры, заданные в `[general]`, применяются ко всем секциям источников;
- если тот же параметр указан в секции источника — он **переопределяет** значение из `[general]`.

Пример:
```ini
[general]
host=myhost.test.local
username=myuser
port=22
download_dirs=test_art
download_date=2025/11/24
keypath=/export/home/myuser/.ssh/id_rsa
protocol=sftp
unpack_gz=True
```

---

## Секции источников копирования

Каждая дополнительная секция описывает **отдельный источник файлов**.

Имя секции произвольное, но должно совпадать с элементом из `download_dirs`.

Пример:
```ini
[test_art]
host=localhost
remote_path=/data/ART/
local_path=/data/sources_art/
file_pattern=ARHFBMS.*
unpack_gz=False
outfile_suffix=.j2
```

---

## Возможные параметры


| Имя                | Описание                                                              | Примечания                                                                                                                                                                                                                                                                                                                                                                |
| ------------------ | --------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `host`             | хост для подключения                                                  | при указании localhost все найденные файлы будут отлинкованы                                                                                              |
| `username`         | имя пользователя для подключения                                      |                                                                                                                                                                                                                                                                                                                                                                           |
| `port`             | порт для подключения                                                  | По умолчанию: 22                                                                                                                                                                                                                                                                                                                                                          |
| `protocol`         | протокол для загрузки файлов                                          | Возможные значения: sftp или ssh<br>По умолчанию: ssh<br>По SFTP выше скорость, поэтому рекомендуется указать его, если важно быстродействие.                                                                                                                                                                                                                             |
| `keypath`          | путь для rsa-ключа в случае подключения ssh по ключу                  | При указании для хоста ключа пароль спрашиваться не будет и сразу будет предпринята попытка подключения. Если в [general] указан ключ, но в определенной секции необходимо подключаться к хосту по паролю, то достаточно просто в ней определить путь к ключу пустым (keypath=)                                                                                           |
| `download_dirs`    | произвольные имена для направлений выгрузки                           | **Данный параметр только для секции [general]**<br>Перечисляются через ',' для каждого из перечисленных направлений должна быть определена секция конфига ниже<br>При запуске будет произведена выгрузка из перечисленных направлений, т.е. необязательно удалять ненужную секцию из конфига, достаточно просто убрать ее из этого параметра<br>Пример: test_art,ssdg,sources |
| `download_date`    | дата загружаемых файлов                                               | Формат: yyyy/mm/dd<br>Эта дата будет использована во всех шаблонах даты '%date%', после использования шаблона обязательно указать формат, в котором подставить дату на место шаблона (см. пример конфига ниже). Этот шаблон можно указывать для параметров remote_path,local_path,subdir_pattern и file_pattern.                                                          |
| `remote_path`      | путь к файлам на удаленном хосте                                      |                                                                                                                                                                                                                                                                                                                                                                           |
| `local_path`       | путь для сохранения файлов на локальной машине                        | Если указан несуществующий локально путь - он будет создан                                                                                                                                                                                                                                                                                                                |
| `file_pattern`     | регулярное выражение для поиска файлов в удаленной директории         | По умолчанию: .\*<br>Пример: ARHFBMS.\*\\.gz                                                                                                                                                                                                                                                                                                                             |
| `outfile_suffix`   | строка, которая будет приписана к скачанному файлу или распакованному | Пример: .j2<br>Иногда полезно, чтобы притащенные файлы уже были с нужными расширениями                                                                                                                                                                                                                  |
| `mtime_choice`     | выбирать файлы по дате изменения атрибутов файла                      | Возможные значения: True\False<br>По умолчанию: False<br>При True буду загружены файлы, подходящие по file_pattern и дате изменения атрибутов из download_date c 00:00:00 по 00:00:00 следующего дня (сутки).<br>Обычно полезно для файлов, в имени которых нет временной метки                                                                         |
| `unpack_gz`        | распаковывать загруженные файлы                                       | Возможные значения: True\False<br>По умолчанию: False<br>Отмеченные для распаковки направления начнут распаковываться после загрузки всех направлений<br>Распаковка будет производиться только для файлов с расширением .gz, поэтому можно не переопределять для направлений, в которых архивов нет                                                                       |
| `recursive_search` | рекурсивный поиск                                                     | Будет произведен рекурсивный поиск файлов в поддиректориях remote_path                                                                                                                                                                                                                                                                                                    |
| `subdir_pattern`   | регулярное выражение для поддиректорий                                | Выражение по которому будут фильтроваться поддиректории внутри удаленной директории<br>Используется вместе с recursive_search                                                                                                                                                                                                                                             |
| `repeat_struct`    | повтор удаленной структуры                                            | При рекурсивном поиске структура удаленных каталогов будет повторена в локальном хранилище<br>Используется вместе с recursive_search                                                                                                                                                                                                                                      |

## Пример конфига

```ini
[general]
host=myhost.test.local
username=myuser
port=22
download_dirs=test_art
download_date=2025/11/24
keypath=/export/home/myuser/.ssh/id_rsa
protocol=sftp
unpack_gz=True

[test_art]

host=localhost
remote_path=/data/ART/
local_path=/data/sources_art/
file_pattern=ARHFBMS.*
mtime_choice=True
unpack_gz=False
outfile_suffix=.j2

[art_prod]

keypath=./ansible_key
host=prod_host.test.local
remote_path=/data/ART/
local_path=/data/etalons_art/
file_pattern=%date%ARHFBMS.*,%Y%m%d
unpack_gz=False
outfile_suffix=.j2
```

---

## Типичные ошибки

- Несовпадение имени секции и `download_dirs`  
- Неверный путь к SSH-ключу  
- Ошибочный шаблон даты в `file_pattern`  
- Отсутствие прав на удалённый каталог

---



